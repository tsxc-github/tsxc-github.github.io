(()=>{const t="kmarBlogCache",e="https://id.v3/",s=()=>caches.match(e).then((t=>t?.json())),n=s=>caches.open(t).then((t=>t.put(e,new Response(JSON.stringify(s)))));self.addEventListener("install",(()=>{self.skipWaiting();s().then((async e=>{if(e&&4!==e.escape){const e=await caches.open(t).then((t=>t.keys())).then((t=>t?.map((t=>t.url))));await caches.delete(t);const s=await m();s.type="escape",s.list=e;(await clients.matchAll()).forEach((t=>t.postMessage(s)))}}))})),self.addEventListener("activate",(t=>t.waitUntil(clients.claim())));const r=(t,e,s,n)=>(n||(n={}),n.cache=e?"no-store":"default",s&&(n.mode="cors",n.credentials="same-origin"),fetch(t,n)),a=(t,e,s)=>r(t,e,!0,s),c=t=>{if("localhost"!==t.hostname)for(let e in h){const s=h[e];if(s.match(t))return s}};let h={simple:{clean:!0,match:t=>/\.(woff2|woff|ttf|cur|css|js|jpg|png|webp|jpeg|avif)$/}},i=t=>{if(t.match("https://blog.tsxc.xyz")&&(t.match("/cdn/")||t.match("/css/")||t.match("/custom/")||t.match("/fonts/")||t.match("/img/")||t.match("/js/")||t.match(".jpg")||t.match(".png")||t.match(".webp")||t.match(".avif")))return{timeout:1e3,list:[t]}},o=()=>!1;const l=(t,e,s=null)=>{if(!s&&!(s=i(t.url)))return a(t,e);const n=s.list,r=new Array(n.length),c=s=>a(new Request(n[s],t),e,{signal:(r[s]=new AbortController).signal}).then((t=>u(t)?{r:t,i:s}:Promise.reject()));return new Promise(((e,a)=>{let h=!0;const i=()=>{h=!1,Promise.any([l,...Array.from({length:n.length-1},((t,e)=>e+1)).map((t=>c(t)))]).then((t=>{for(let e=0;e!==n.length;++e)e!==t.i&&r[e].abort();e(t.r)})).catch((()=>a(`请求 ${t.url} 失败`)))},o=setTimeout(i,s.timeout),l=c(0).then((t=>{h&&(clearTimeout(o),e(t.r))})).catch((()=>(h&&(clearTimeout(o),i()),Promise.reject())))}))},u=t=>t.ok||[301,302,307,308].includes(t.status),f=new Map;self.addEventListener("fetch",(e=>{let s=e.request,n=new URL(s.url);if("GET"!==s.method||!s.url.startsWith("http"))return;if((t=>!(t.url.startsWith("https://blog.tsxc.xyz")||t.url.startsWith("https://server.tsxc.xyz")))(s))return;let a,h=n.hostname+n.pathname+n.search;if((t=>{t.url.startsWith("https://blog.tsxc.xyz")||t.url.startsWith("https://server.tsxc.xyz")})(s)){if(a=f.get(h),a)return e.respondWith(new Promise(((t,e)=>{f.get(h).push((s=>s.body?t(s):e(s)))})));f.set(h,a=[])}const m=t=>{e.respondWith(a?t.then((t=>{for(let e of a)e(t.clone())})).catch((t=>{for(let e of a)e(t)})).then((()=>(f.delete(h),t))):t)},p=c(n);if(p){let e=`https://${n.host}${n.pathname}`;e.endsWith("/index.html")&&(e=e.substring(0,e.length-10)),p.search&&(e+=n.search),m(caches.match(e).then((n=>n??l(s,!0).then((s=>{if(u(s)){const n=s.clone();caches.open(t).then((t=>t.put(e,n)))}return s})))))}else{const t=i(s.url);m(t?l(s,!1,t):((t,e)=>r(t,!1,o(t),e))(s).catch((t=>new Response(t,{status:499}))))}})),self.addEventListener("message",(t=>{"update"===t.data&&m().then((e=>{e.type="update",t.source.postMessage(e)}))}));const m=async()=>{const r=await l(new Request("/update.json"),!1);if(!u(r))throw`加载 update.json 时遇到异常，状态码：${r.status}`;const a=await r.json(),c=await(t=>s().then((e=>{const{info:s,global:r}=t,a={global:r,local:s[0].version,escape:e?.escape??0};if(!e)return a.escape=4,n(a),{new:a,old:e};let c=new p,h=((t,e,s)=>{for(let n of e){const{version:e,change:r}=n;if(e===s)return!1;if(r)for(let e of r)t.push(new g(e))}return!0})(c,s,e.local);return n(a),h&&(r!==e.global?c.force=!0:c.refresh=!0),{list:c,new:a,old:e}})))(a);if(c.list){const s=await(s=>caches.open(t).then((t=>t.keys().then((n=>Promise.all(n.map((async n=>{const r=n.url;return r!==e&&s.match(r)?(t.delete(n),r):null}))))).then((t=>t.filter((t=>t)))))))(c.list);c.list=s?.length?s:null}return c};function p(){const t=[];this.push=e=>{t.push(e)},this.match=e=>{if(this.force)return!0;if(e=new URL(e),this.refresh)return c(e).clean;for(let s of t)if(s.match(e))return!0;return!1}}function g(t){const e=e=>{const s=t.value;if(Array.isArray(s)){for(let t of s)if(e(t))return!0;return!1}return e(s)};this.match=(()=>{switch(t.flag){case"html":return t=>t.pathname.match(/(\/|\.html)$/);case"end":return t=>e((e=>t.href.endsWith(e)));case"begin":return t=>e((e=>t.pathname.startsWith(e)));case"str":return t=>e((e=>t.href.includes(e)));case"reg":return t=>e((e=>t.href.match(new RegExp(e,"i"))));default:throw`未知表达式：${JSON.stringify(t)}`}})()}})();